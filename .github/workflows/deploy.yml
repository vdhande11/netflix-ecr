name: Build & Push Netflix Image to ECR

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: us-east-1                   # <-- CHANGE if your ECR is in a different region
  AWS_ACCOUNT_ID: "099125039129"           # <-- CHANGE to your actual AWS account ID
  ECR_REPOSITORY: "netflix"                # <-- CHANGE to your ECR repository name
  IMAGE_TAG: "latest"

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Ensure AWS CLI can reach ECR and the repo exists; create it if missing
      - name: Ensure ECR repository exists
        run: |
          set -e
          aws --version
          echo "Checking ECR repo: ${ECR_REPOSITORY} in ${AWS_REGION}"
          aws ecr describe-repositories \
            --repository-names "${ECR_REPOSITORY}" \
            --region "${AWS_REGION}" >/dev/null 2>&1 || \
          aws ecr create-repository \
            --repository-name "${ECR_REPOSITORY}" \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --region "${AWS_REGION}"

      - name: Login to Amazon ECR
        run: |
          set -e
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "Logging in to ECR registry: ${REGISTRY}"
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${REGISTRY}"

      - name: Build Docker Image
        run: |
          docker build -t "${ECR_REPOSITORY}:${IMAGE_TAG}" .

      - name: Tag Image for ECR
        run: |
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          docker tag "${ECR_REPOSITORY}:${IMAGE_TAG}" \
            "${REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"

      - name: Push Image to ECR
        run: |
          set -e
          REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          docker push "${REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
